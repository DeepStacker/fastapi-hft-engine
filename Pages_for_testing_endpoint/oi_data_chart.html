<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live Option Chain Viewer</title>
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #f1f3f5;
            --accent: #007bff;
            --bg: #f8f9fa;
            --text: #333;
            --border: #dee2e6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 30px;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        h1 {
            color: var(--primary);
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
        }

        label {
            font-weight: 600;
            font-size: 1.1rem;
        }

        select {
            padding: 10px 15px;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 250px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }

        select:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        #optionsData {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            min-height: 120px;
            font-style: italic;
            color: #6c757d;
            text-align: center;
        }

        .loading {
            font-weight: bold;
            color: #17a2b8;
        }

        .error {
            font-weight: bold;
            color: #dc3545;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95rem;
            background-color: #fff;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px 12px;
            text-align: right;
            cursor: pointer;
        }

        th {
            background: linear-gradient(to right, #e9ecef, #f1f3f5);
            color: #212529;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 10px;
            z-index: 2;
        }

        .strike {
            font-weight: bold;
            background-color: var(--secondary);
            text-align: center;
            color: var(--primary);
        }

        tr:nth-child(even) td:not(.strike) {
            background-color: #fbfbfb;
        }

        tr:hover td:not(.strike) {
            background-color: #f0f8ff;
        }

        .delta-iv {
            font-size: 0.85em;
            color: #666;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        /* Modal Styling */
        #chartModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chartModal .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            width: 80vw;
            height: 75vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        #chartModal .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #dc3545;
            color: #fff;
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            select {
                min-width: 100%;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <h1>üìä Live Option Chain</h1>

    <div class="header">
        <label for="instSelect">Choose Instrument:</label>
        <select id="instSelect" onchange="changeInstrument(this.value)">
            <option value="">-- Select Instrument --</option>
        </select>
    </div>

    <div id="optionsData">Please select an instrument to view the live option chain.</div>

    <!-- Chart Modal -->
    <div id="chartModal">
        <div class="modal-content">
            <button onclick="closeChart()" class="close-btn">‚úñ Close</button>
            <canvas id="popupChart" style="width:100%; height:100%;"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const symbol_list = {
            "NIFTY": 13, "BANKNIFTY": 25, "FINNIFTY": 27, "MIDCPNIFTY": 442, "NIFTYNXT50": 38,
            "SENSEX": 51, "BANKEX": 69, "CRUDEOIL": 294, "ADANIENT": 25, "ADANIPORTS": 15083,
            "APOLLOHOSP": 157, "ASIANPAINT": 236, "AXISBANK": 5900, "BAJAJ-AUTO": 16669,
            "BAJFINANCE": 317, "BAJAJFINSV": 16675, "BEL": 383, "BPCL": 526, "BHARTIARTL": 10604,
            "BRITANNIA": 547, "CIPLA": 694, "COALINDIA": 20374, "DRREDDY": 881, "EICHERMOT": 910,
            "GRASIM": 1232, "HCLTECH": 7229, "HDFCBANK": 1333, "HDFCLIFE": 467, "HEROMOTOCO": 1348,
            "HINDALCO": 1363, "HINDUNILVR": 1394, "ICICIBANK": 4963, "ITC": 1660, "INDUSINDBK": 5258,
            "INFY": 1594, "JSWSTEEL": 11723, "KOTAKBANK": 1922, "LT": 11483, "MM": 2031, "MARUTI": 10999,
            "NTPC": 11630, "NESTLEIND": 17963, "ONGC": 2475, "POWERGRID": 14977, "RELIANCE": 2885,
            "SBILIFE": 21808, "SHRIRAMFIN": 4306, "SBIN": 3045, "SUNPHARMA": 3351, "TCS": 11536,
            "TATACONSUM": 3432, "TATAMOTORS": 3456, "TATASTEEL": 3499, "TECHM": 13538, "TITAN": 3506,
            "TRENT": 1964, "ULTRACEMCO": 11532, "WIPRO": 3787
        };

        let socket;
        const optionsDataDiv = document.getElementById('optionsData');

        const select = document.getElementById('instSelect');
        const sortedSymbols = Object.entries(symbol_list).sort((a, b) => a[0].localeCompare(b[0]));
        sortedSymbols.forEach(([name, id]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            select.appendChild(option);
        });

        function changeInstrument(inst_id) {
            if (!inst_id) {
                optionsDataDiv.innerHTML = "Please select an instrument to view the live option chain.";
                optionsDataDiv.className = '';
                return;
            }

            if (socket) socket.close();

            optionsDataDiv.innerHTML = `<span class="loading">‚è≥ Connecting to WebSocket and fetching data for ${select.options[select.selectedIndex].text}...</span>`;
            optionsDataDiv.className = 'loading';

            socket = new WebSocket(`ws://localhost:8000/ws/${inst_id}`);

            socket.onopen = () => {
                console.log("WebSocket connected");
                optionsDataDiv.innerHTML = `<span class="loading">‚úÖ Connected. Waiting for data...</span>`;
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.options && data.options.length > 0) {
                        renderOptions(data.options);
                        optionsDataDiv.className = '';
                        optionsDataDiv.style.fontStyle = 'normal';
                        optionsDataDiv.style.color = 'inherit';
                    } else if (data.message) {
                        optionsDataDiv.innerHTML = `<span class="loading">${data.message}</span>`;
                    } else {
                        optionsDataDiv.innerHTML = `<span class="loading">Data format unexpected or empty.</span>`;
                    }
                } catch (e) {
                    console.error("Parsing/render error:", e);
                    optionsDataDiv.innerHTML = `<span class="error">‚ö†Ô∏è Error processing server data.</span>`;
                    optionsDataDiv.className = 'error';
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
                optionsDataDiv.innerHTML = `<span class="error">‚ùå WebSocket error. Check server status.</span>`;
                optionsDataDiv.className = 'error';
            };

            socket.onclose = (event) => {
                console.log("WebSocket closed:", event.code, event.reason);
                if (!event.wasClean) {
                    optionsDataDiv.innerHTML = `<span class="error">üîå Unexpected disconnection. Retry or refresh.</span>`;
                    optionsDataDiv.className = 'error';
                }
            };
        }

        function formatNumber(num) {
            if (num === null || num === undefined || num === '') return '';
            return Number(num).toLocaleString('en-IN');
        }

        function renderOptions(options) {
            const calls = {}, puts = {};
            for (const o of options) {
                const key = o.strike_price;
                if (o.option_type === 'CE') calls[key] = o;
                else if (o.option_type === 'PE') puts[key] = o;
            }

            const allStrikes = Array.from(new Set([...Object.keys(calls), ...Object.keys(puts)])).map(parseFloat).sort((a, b) => a - b);

            let rows = allStrikes.map(strike => {
                const ce = calls[strike] || {};
                const pe = puts[strike] || {};

                const ceDelta = ce.delta !== undefined ? ce.delta.toFixed(2) : '-';
                const ceIV = ce.implied_volatility !== undefined ? ce.implied_volatility.toFixed(2) : '-';
                const peDelta = pe.delta !== undefined ? pe.delta.toFixed(2) : '-';
                const peIV = pe.implied_volatility !== undefined ? pe.implied_volatility.toFixed(2) : '-';

                return `
                    <tr>
                        <td class="delta-iv" onclick="showChart(${ce.symbol_id}, 'delta')">${ceDelta} / ${ceIV}%</td>
                        <td onclick="showChart(${ce.symbol_id}, 'open_interest')">${formatNumber(ce.open_interest)}</td>
                        <td onclick="showChart(${ce.symbol_id}, 'oi_change')">${formatNumber(ce.oi_change)}</td>
                        <td onclick="showChart(${ce.symbol_id}, 'volume')">${formatNumber(ce.volume)}</td>
                        <td onclick="showChart(${ce.symbol_id}, 'ltp')">${ce.ltp ?? '-'}</td>

                        <td class="strike">${strike}</td>

                        <td onclick="showChart(${pe.symbol_id}, 'ltp')">${pe.ltp ?? '-'}</td>
                        <td onclick="showChart(${pe.symbol_id}, 'volume')">${formatNumber(pe.volume)}</td>
                        <td onclick="showChart(${pe.symbol_id}, 'oi_change')">${formatNumber(pe.oi_change)}</td>
                        <td onclick="showChart(${pe.symbol_id}, 'open_interest')">${formatNumber(pe.open_interest)}</td>
                        <td class="delta-iv" onclick="showChart(${pe.symbol_id}, 'delta')">${peDelta} / ${peIV}%</td>
                    </tr>
                `;
            }).join("");

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th colspan="5">CALLS (CE)</th>
                            <th rowspan="2" class="strike">Strike</th>
                            <th colspan="5">PUTS (PE)</th>
                        </tr>
                        <tr>
                            <th>Delta / IV</th>
                            <th>OI</th>
                            <th>OI Chg</th>
                            <th>Volume</th>
                            <th>LTP</th>
                            <th>LTP</th>
                            <th>Volume</th>
                            <th>OI Chg</th>
                            <th>OI</th>
                            <th>Delta / IV</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;

            optionsDataDiv.innerHTML = html;
        }

        let chartInstance = null;

        function showChart(symbol_id, chartType) {
            fetch(`http://localhost:8000/io-data/?symbol_id=${symbol_id}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.data || !Array.isArray(data.data.timestamp)) {
                        console.error("Invalid data format:", data);
                        alert("Failed to load chart data. Invalid data format.");
                        return;
                    }

                    const rawData = data.data;
                    const timestamps = rawData.timestamp.map(t => {
                        // Convert to time only (e.g., "16:02")
                        const date = new Date(t);
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    });

                    let ceData = [];
                    let peData = [];
                    let diffData = [];
                    let label = '';
                    let borderColorCE = '#007bff';
                    let borderColorPE = '#dc3545';
                    let borderColorDiff = '#ffc107';

                    // Helper to extract CE and PE from full array
                    function splitCePe(array) {
                        const mid = Math.floor(array.length / 2);
                        return {
                            ce: array.slice(0, mid),
                            pe: array.slice(mid),
                        };
                    }

                    switch (chartType) {
                        case 'ltp':
                            label = 'LTP';
                            ({ ce, pe } = splitCePe(rawData.ltp));
                            ceData = ce;
                            peData = pe;
                            break;
                        case 'delta':
                            label = 'Delta';
                            ({ ce, pe } = splitCePe(rawData.delta));
                            ceData = ce;
                            peData = pe;
                            break;
                        case 'iv':
                            label = 'IV';
                            ({ ce, pe } = splitCePe(rawData.iv));
                            ceData = ce;
                            peData = pe;
                            break;
                        case 'oi':
                            label = 'OI';
                            ({ ce, pe } = splitCePe(rawData.oi));
                            ceData = ce;
                            peData = pe;
                            break;
                        case 'oi_change':
                            label = 'OI Change';
                            ({ ce, pe } = splitCePe(rawData.oi_change));
                            ceData = ce;
                            peData = pe;
                            break;
                        case 'volume':
                            label = 'Volume';
                            ({ ce, pe } = splitCePe(rawData.volume_change));
                            ceData = ce;
                            peData = pe;
                            break;
                        default:
                            alert("Unknown chart type: " + chartType);
                            return;
                    }

                    // Calculate difference
                    diffData = ceData.map((ceVal, idx) => peData[idx] - ceVal);

                    const datasets = [
                        {
                            label: `CE ${label}`,
                            data: ceData,
                            borderColor: borderColorCE,
                            backgroundColor: 'transparent',
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: `PE ${label}`,
                            data: peData,
                            borderColor: borderColorPE,
                            backgroundColor: 'transparent',
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: `PE - CE ${label}`,
                            data: diffData,
                            borderColor: borderColorDiff,
                            backgroundColor: 'transparent',
                            fill: false,
                            borderWidth: 2
                        }
                    ];

                    if (chartInstance) chartInstance.destroy();

                    const ctx = document.getElementById('popupChart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Time' },
                                    ticks: {
                                        maxTicksLimit: 10,
                                        autoSkip: true
                                    }
                                },
                                y: {
                                    title: { display: true, text: label },
                                    beginAtZero: false
                                }
                            }
                        }
                    });

                    document.getElementById('chartModal').style.display = 'flex';
                })
                .catch(err => {
                    console.error("Chart error", err);
                    alert("Failed to load chart data.");
                });
        }


        function closeChart() {
            document.getElementById('chartModal').style.display = 'none';
            if (chartInstance) chartInstance.destroy();
        }
    </script>
</body>

</html>