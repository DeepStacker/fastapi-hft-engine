<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live Option Chain Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .header {
            margin-bottom: 20px;
            text-align: center;
        }

        select {
            padding: 5px 10px;
            font-size: 16px;
        }

        #optionsData {
            overflow-x: auto;
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        td.strike {
            font-weight: bold;
            background: #f0f0f0;
        }

        td:hover {
            cursor: pointer;
            background-color: #eef;
        }

        .loading {
            text-align: center;
            color: #555;
            font-size: 16px;
        }

        .error {
            color: red;
            font-weight: bold;
            text-align: center;
        }

        #chartModal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            width: 90%;
            max-width: 800px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }

        .delta-iv {
            background: #fdfdd0;
        }
    </style>
</head>

<body>
    <h1>üìä Live Option Chain Viewer</h1>

    <div class="header">
        <label for="instSelect">Select Instrument:</label>
        <select id="instSelect" onchange="changeInstrument(this.value)">
            <option value="">-- Select --</option>
        </select>
    </div>

    <div id="optionsData">Please select an instrument to load the live option chain.</div>

    <!-- Chart Modal -->
    <div id="chartModal">
        <div class="modal-content">
            <button onclick="closeChart()" class="close-btn">‚úñ Close</button>
            <canvas id="popupChart" style="width:100%; height:400px;"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const symbol_list = {
            "NIFTY": 13,
            "BANKNIFTY": 25,
            "FINNIFTY": 27,
            "MIDCPNIFTY": 442,
            "RELIANCE": 2885,
            "SBIN": 3045,
            "TCS": 11536,
            "INFY": 1594,
            "ITC": 1660,
            "HDFCBANK": 1333
        };

        const select = document.getElementById('instSelect');
        const optionsDataDiv = document.getElementById('optionsData');
        let socket;

        Object.entries(symbol_list)
            .sort((a, b) => a[0].localeCompare(b[0]))
            .forEach(([name, id]) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = name;
                select.appendChild(opt);
            });

        function changeInstrument(inst_id) {
            if (!inst_id) {
                optionsDataDiv.innerHTML = "Please select an instrument to view the live option chain.";
                return;
            }

            if (socket) socket.close();

            const instName = select.options[select.selectedIndex].text;
            optionsDataDiv.innerHTML = `<span class="loading">‚è≥ Connecting to server for ${instName}...</span>`;

            socket = new WebSocket(`ws://localhost:8000/ws/${inst_id}`);

            socket.onopen = () => {
                optionsDataDiv.innerHTML = `<span class="loading">‚úÖ Connected. Waiting for data...</span>`;
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.options && data.options.length > 0) {
                        renderOptions(data.options);
                    } else {
                        optionsDataDiv.innerHTML = `<span class="loading">No option data received.</span>`;
                    }
                } catch (err) {
                    optionsDataDiv.innerHTML = `<span class="error">Error parsing option data.</span>`;
                }
            };

            socket.onerror = () => {
                optionsDataDiv.innerHTML = `<span class="error">WebSocket error. Check connection or server.</span>`;
            };

            socket.onclose = () => {
                optionsDataDiv.innerHTML = `<span class="error">WebSocket disconnected.</span>`;
            };
        }

        function formatNumber(num) {
            return num ? Number(num).toLocaleString('en-IN') : '-';
        }

        function renderOptions(options) {
            const calls = {}, puts = {};

            options.forEach(o => {
                const strike = o.strike_price;
                if (o.ce_symbol_id) {
                    if (!calls[strike]) calls[strike] = {};
                    Object.assign(calls[strike], o);
                }
                if (o.pe_symbol_id) {
                    if (!puts[strike]) puts[strike] = {};
                    Object.assign(puts[strike], o);
                }
            });

            const allStrikes = Array.from(new Set([...Object.keys(calls), ...Object.keys(puts)]))
                .map(Number)
                .sort((a, b) => a - b);

            const rows = allStrikes.map(strike => {
                const ce = calls[strike] || {};
                const pe = puts[strike] || {};

                return `
          <tr>
            <td class="delta-iv" onclick="showChart(${ce.ce_symbol_id || 0}, 'delta')">
              ${ce.ce_delta?.toFixed(2) ?? '-'} / ${ce.ce_implied_volatility?.toFixed(2) ?? '-'}%
            </td>
            <td onclick="showChart(${ce.ce_symbol_id || 0}, 'open_interest')">${formatNumber(ce.ce_open_interest)}</td>
            <td onclick="showChart(${ce.ce_symbol_id || 0}, 'oi_change')">${formatNumber(ce.ce_oi_change)}</td>
            <td onclick="showChart(${ce.ce_symbol_id || 0}, 'volume')">${formatNumber(ce.ce_volume)}</td>
            <td onclick="showChart(${ce.ce_symbol_id || 0}, 'ltp')">${ce.ce_ltp ?? '-'}</td>

            <td class="strike">${strike}</td>

            <td onclick="showChart(${pe.pe_symbol_id || 0}, 'ltp')">${pe.pe_ltp ?? '-'}</td>
            <td onclick="showChart(${pe.pe_symbol_id || 0}, 'volume')">${formatNumber(pe.pe_volume)}</td>
            <td onclick="showChart(${pe.pe_symbol_id || 0}, 'oi_change')">${formatNumber(pe.pe_oi_change)}</td>
            <td onclick="showChart(${pe.pe_symbol_id || 0}, 'open_interest')">${formatNumber(pe.pe_open_interest)}</td>
            <td class="delta-iv" onclick="showChart(${pe.pe_symbol_id || 0}, 'delta')">
              ${pe.pe_delta?.toFixed(2) ?? '-'} / ${pe.pe_implied_volatility?.toFixed(2) ?? '-'}%
            </td>
          </tr>
        `;
            }).join('');

            optionsDataDiv.innerHTML = `
        <table>
          <thead>
            <tr>
              <th colspan="5">CALLS (CE)</th>
              <th rowspan="2" class="strike">Strike</th>
              <th colspan="5">PUTS (PE)</th>
            </tr>
            <tr>
              <th>Delta / IV</th>
              <th>OI</th>
              <th>OI Chg</th>
              <th>Volume</th>
              <th>LTP</th>
              <th>LTP</th>
              <th>Volume</th>
              <th>OI Chg</th>
              <th>OI</th>
              <th>Delta / IV</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
        }

        let chartInstance;

        function showChart(symbol_id, chartType) {
            fetch(`http://localhost:8000/io-data/?symbol_id=${symbol_id}`)
                .then(res => res.json())
                .then(data => {
                    const raw = data.data;
                    const timestamps = raw.timestamp.map(t =>
                        new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));

                    const split = arr => {
                        const mid = Math.floor(arr.length / 2);
                        return { ce: arr.slice(0, mid), pe: arr.slice(mid) };
                    };

                    let ce = [], pe = [], label = chartType.toUpperCase();
                    switch (chartType) {
                        case 'ltp': ({ ce, pe } = split(raw.ltp)); break;
                        case 'delta': ({ ce, pe } = split(raw.delta)); break;
                        case 'iv': ({ ce, pe } = split(raw.iv)); break;
                        case 'oi': ({ ce, pe } = split(raw.oi)); break;
                        case 'oi_change': ({ ce, pe } = split(raw.oi_change)); break;
                        case 'volume': ({ ce, pe } = split(raw.volume_change)); break;
                        default: return;
                    }

                    const diff = ce.map((c, i) => (pe[i] ?? 0) - (c ?? 0));

                    if (chartInstance) chartInstance.destroy();

                    chartInstance = new Chart(document.getElementById('popupChart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                { label: `CE ${label}`, data: ce, borderColor: '#007bff', fill: false },
                                { label: `PE ${label}`, data: pe, borderColor: '#dc3545', fill: false },
                                { label: `Diff (PE - CE)`, data: diff, borderColor: '#ffc107', fill: false }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { title: { display: true, text: 'Time' } },
                                y: { title: { display: true, text: label } }
                            }
                        }
                    });

                    document.getElementById('chartModal').style.display = 'flex';
                });
        }

        function closeChart() {
            document.getElementById('chartModal').style.display = 'none';
            if (chartInstance) chartInstance.destroy();
        }
    </script>
</body>

</html>