# Docker Compose Configuration for New Services
# Add these to main docker-compose.yml

  # Analytics Service - Post-storage stateful analysis
  analytics-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stockify-analytics
    command: python -m services.analytics.main
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SECRET_KEY: ${SECRET_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-development}
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    networks:
      - stockify-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Historical Service - Time-series queries API
  historical-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stockify-historical
    command: uvicorn services.historical.main:app --host 0.0.0.0 --port 8002
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: ${SECRET_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-development}
    ports:
      - "8002:8002"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - stockify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # API Gateway - B2B API distribution
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stockify-api-gateway
    command: uvicorn services.api_gateway.main:app --host 0.0.0.0 --port 8003
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: ${SECRET_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-development}
    ports:
      - "8003:8003"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      historical-service:
        condition: service_healthy
    networks:
      - stockify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
